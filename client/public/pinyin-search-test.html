<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‹¼éŸ³æœç´¢æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .search-box {
            margin: 20px 0;
        }
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 16px;
        }
        input:focus {
            outline: none;
            border-color: #0366d6;
        }
        .results {
            margin-top: 20px;
        }
        .result-item {
            padding: 12px;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            margin: 8px 0;
            background: #f8f9fa;
        }
        .product-name {
            font-weight: 600;
            color: #1f2328;
        }
        .product-details {
            color: #656d76;
            font-size: 14px;
            margin-top: 4px;
        }
        .test-queries {
            margin: 20px 0;
        }
        .query-button {
            display: inline-block;
            margin: 4px;
            padding: 8px 12px;
            background: #0366d6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .query-button:hover {
            background: #0256cc;
        }
        .no-results {
            text-align: center;
            color: #656d76;
            padding: 40px;
        }
        .loading {
            text-align: center;
            color: #656d76;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” æ‹¼éŸ³æœç´¢åŠŸèƒ½æµ‹è¯•</h1>
        <p>æµ‹è¯•ä¸­æ–‡äº§å“åç§°çš„æ‹¼éŸ³æœç´¢åŠŸèƒ½</p>
        
        <div class="search-box">
            <input 
                type="text" 
                id="searchInput" 
                placeholder="è¾“å…¥æ‹¼éŸ³æˆ–ä¸­æ–‡æœç´¢äº§å“ï¼Œä¾‹å¦‚ï¼šppã€qiufaã€chengcha..." 
                autocomplete="off"
            />
        </div>

        <div class="test-queries">
            <h3>å¿«é€Ÿæµ‹è¯•:</h3>
            <button class="query-button" onclick="testSearch('pp')">pp</button>
            <button class="query-button" onclick="testSearch('qiufa')">qiufa (çƒé˜€)</button>
            <button class="query-button" onclick="testSearch('cczf')">cczf (æ‰¿æ’)</button>
            <button class="query-button" onclick="testSearch('flam')">flam (æ³•å…°)</button>
            <button class="query-button" onclick="testSearch('wantou')">wantou (å¼¯å¤´)</button>
            <button class="query-button" onclick="testSearch('zhijie')">zhijie (ç›´æ¥)</button>
            <button class="query-button" onclick="clearSearch()">æ¸…ç©º</button>
        </div>

        <div id="results" class="results">
            <div class="no-results">è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢</div>
        </div>
    </div>

    <script type="module">
        import { pinyin } from '/node_modules/pinyin/lib/esm/pinyin.js';

        // æ‹¼éŸ³å·¥å…·å‡½æ•°
        const pinyinUtils = {
            toFullPinyin(text) {
                if (!text) return '';
                return pinyin(text, {
                    style: 'normal',
                    tone: false
                }).flat().join('').toLowerCase();
            },
            
            toFirstLetters(text) {
                if (!text) return '';
                return pinyin(text, {
                    style: 'normal',
                    tone: false
                }).flat().map(p => p[0]).join('').toLowerCase();
            },
            
            isMatch(text, query) {
                if (!text || !query) return false;
                
                const lowerQuery = query.toLowerCase();
                const fullPinyin = this.toFullPinyin(text);
                const firstLetters = this.toFirstLetters(text);
                
                return fullPinyin.includes(lowerQuery) || 
                       firstLetters.includes(lowerQuery) ||
                       fullPinyin.startsWith(lowerQuery) ||
                       firstLetters.startsWith(lowerQuery);
            },
            
            getMatchScore(text, query) {
                if (!text || !query) return 0;
                
                const lowerQuery = query.toLowerCase();
                const fullPinyin = this.toFullPinyin(text);
                const firstLetters = this.toFirstLetters(text);
                
                if (fullPinyin === lowerQuery || firstLetters === lowerQuery) return 100;
                if (fullPinyin.startsWith(lowerQuery)) return 80;
                if (firstLetters.startsWith(lowerQuery)) return 75;
                if (fullPinyin.includes(lowerQuery)) return 50;
                if (firstLetters.includes(lowerQuery)) return 45;
                
                return 0;
            }
        };

        let allProducts = [];
        
        // åŠ è½½äº§å“æ•°æ®
        async function loadProducts() {
            try {
                const response = await fetch('http://localhost:3003/api/products?limit=1000');
                const data = await response.json();
                allProducts = data.products || [];
                console.log('åŠ è½½äº†', allProducts.length, 'ä¸ªäº§å“');
                
                // é¢„å¤„ç†æ‹¼éŸ³æ•°æ®
                allProducts.forEach(product => {
                    product.fullPinyin = pinyinUtils.toFullPinyin(product.name);
                    product.firstLetters = pinyinUtils.toFirstLetters(product.name);
                    console.log(`${product.name} -> ${product.fullPinyin} (${product.firstLetters})`);
                });
            } catch (error) {
                console.error('åŠ è½½äº§å“å¤±è´¥:', error);
            }
        }

        // æœç´¢å‡½æ•°
        async function searchProducts(query) {
            if (!query.trim()) {
                return [];
            }

            const isEnglishInput = /^[a-zA-Z]+$/.test(query.trim());
            
            if (isEnglishInput) {
                // æ‹¼éŸ³æœç´¢
                console.log('æ‹¼éŸ³æœç´¢:', query);
                const matches = allProducts.filter(product => {
                    return pinyinUtils.isMatch(product.name, query) ||
                           (product.category_name && pinyinUtils.isMatch(product.category_name, query));
                });

                // æŒ‰åŒ¹é…åˆ†æ•°æ’åº
                const sortedMatches = matches.sort((a, b) => {
                    const scoreA = pinyinUtils.getMatchScore(a.name, query) + 
                                  (a.category_name ? pinyinUtils.getMatchScore(a.category_name, query) : 0);
                    const scoreB = pinyinUtils.getMatchScore(b.name, query) + 
                                  (b.category_name ? pinyinUtils.getMatchScore(b.category_name, query) : 0);
                    return scoreB - scoreA;
                });

                console.log('æ‹¼éŸ³åŒ¹é…ç»“æœ:', sortedMatches.length);
                return sortedMatches.slice(0, 10);
            } else {
                // å¸¸è§„æœç´¢
                console.log('å¸¸è§„æœç´¢:', query);
                return allProducts.filter(product => 
                    product.name.toLowerCase().includes(query.toLowerCase()) ||
                    (product.category_name && product.category_name.toLowerCase().includes(query.toLowerCase()))
                ).slice(0, 10);
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResults(products, query) {
            const resultsDiv = document.getElementById('results');
            
            if (products.length === 0) {
                resultsDiv.innerHTML = '<div class="no-results">æœªæ‰¾åˆ°åŒ¹é…çš„äº§å“</div>';
                return;
            }

            const isEnglishInput = /^[a-zA-Z]+$/.test(query.trim());
            
            const html = products.map(product => {
                let highlightInfo = '';
                if (isEnglishInput) {
                    const score = pinyinUtils.getMatchScore(product.name, query) + 
                                 (product.category_name ? pinyinUtils.getMatchScore(product.category_name, query) : 0);
                    highlightInfo = ` (æ‹¼éŸ³åŒ¹é…, åˆ†æ•°: ${score})`;
                }
                
                return `
                    <div class="result-item">
                        <div class="product-name">${product.name}${highlightInfo}</div>
                        <div class="product-details">
                            æ¡ç : ${product.barcode || 'æœªè®¾ç½®'} | 
                            åˆ†ç±»: ${product.category_name || 'æœªåˆ†ç±»'} | 
                            åº“å­˜: ${product.stock || 0}
                            ${isEnglishInput ? `<br>æ‹¼éŸ³: ${product.fullPinyin} (${product.firstLetters})` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            resultsDiv.innerHTML = html;
        }

        // æœç´¢å¤„ç†å‡½æ•°
        let searchTimeout;
        async function handleSearch() {
            const query = document.getElementById('searchInput').value;
            
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                if (!query.trim()) {
                    document.getElementById('results').innerHTML = '<div class="no-results">è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢</div>';
                    return;
                }

                document.getElementById('results').innerHTML = '<div class="loading">æœç´¢ä¸­...</div>';
                
                try {
                    const results = await searchProducts(query);
                    displayResults(results, query);
                } catch (error) {
                    console.error('æœç´¢å¤±è´¥:', error);
                    document.getElementById('results').innerHTML = '<div class="no-results">æœç´¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</div>';
                }
            }, 300);
        }

        // æµ‹è¯•æœç´¢å‡½æ•°
        window.testSearch = function(query) {
            document.getElementById('searchInput').value = query;
            handleSearch();
        };

        window.clearSearch = function() {
            document.getElementById('searchInput').value = '';
            document.getElementById('results').innerHTML = '<div class="no-results">è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢</div>';
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            await loadProducts();
            
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', handleSearch);
            searchInput.focus();
        });
    </script>
</body>
</html>
